<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1200px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    .file-upload-area{
      border:2px dashed var(--border-color);
      border-radius:8px;
      padding:40px 20px;
      text-align:center;
      background:var(--light-bg);
      cursor:pointer;
      transition:border-color .2s, background .2s;
    }
    .file-upload-area:hover{
      border-color:var(--primary-color);
      background:#f0f7f4;
    }
    .file-upload-area.has-file{
      border-color:var(--primary-color);
      background:#e9f6f0;
    }
    .upload-icon{
      font-size:48px;
      color:var(--primary-color);
      margin-bottom:12px;
    }
    .file-name{
      margin-top:12px;
      font-weight:600;
      color:var(--primary-color);
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
    }
    th, td{
      border:1px solid var(--border-color);
      padding:10px;
      text-align:left;
    }
    th{
      background:var(--light-bg);
      font-weight:600;
    }
    tr:nth-child(even){
      background:#fafafa;
    }
    .preview-container{
      max-height:400px;
      overflow:auto;
      margin-top:16px;
    }
    .json-preview{
      background:#f8f9fa;
      border:1px solid var(--border-color);
      border-radius:6px;
      padding:16px;
      font-family:monospace;
      font-size:12px;
      white-space:pre-wrap;
      max-height:400px;
      overflow:auto;
    }
    
    /* Loading spinner */
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading { display: flex; align-items: center; gap: 8px; }
    
    .help-text {
      background: #f8f9fa;
      border-left: 3px solid var(--primary-color);
      padding: 12px;
      margin: 12px 0;
      font-size: 14px;
    }
    .help-text ul {
      margin: 8px 0;
      padding-left: 20px;
    }
    .help-text li {
      margin-bottom: 4px;
    }
    
    .date-format-info {
      background: #e9f6f0;
      border: 1px solid var(--primary-color);
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Select Metric</h2>
      <div class="controls">
        <div>
          <label for="metric-select">External Metric</label>
          <select id="metric-select">
            <option value="">Select a metric...</option>
          </select>
          <div class="muted">Choose the metric to upload data for - ‚úÖ = Active Metric : ‚ùå= Inactive Metric </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="section-title">Upload CSV File</h2>
      <div class="date-format-info">
        <strong>‚ö†Ô∏è Your file must be saved as a .csv file.
      </div>
      <div class="help-text">
        <strong>CSV Format Requirements:</strong>
        <ul>
          <li><strong>Optional:</strong> <code>userId</code> (can be used instead of userEmail)</li>
          <li><strong>Optional:</strong> <code>userEmail</code> (can be used instead of userId)</li>

          <li><strong>Required:</strong> <code>dateOccurred</code> (DD/MM/YYYY or YYYY-MM-DD format)</li>
          <li><strong>Required:</strong> <code>value</code> (numeric value)</li>
          <li><strong>Required:</strong> <code>type</code> ("Total" or "Cumulative")</li>
        </ul>
        Either userId OR userEmail must be populated in the table to match to the correct user.
      </div>
      <div id="fileUploadArea" class="file-upload-area">
        <div class="upload-icon">üìÅ</div>
        <div><strong>Click to upload CSV file</strong></div>
        <div class="muted" style="margin-top: 8px;">or drag and drop your file here</div>
        <div class="muted">Minimum columns: userId/userEmail, dateOccurred, value, type</div>
      </div>
      <input type="file" id="fileInput" accept=".csv" style="display:none" />
      <div id="fileName" class="file-name"></div>
    </div>

    <div id="csvPreviewCard" class="card" style="display:none;">
      <h2 class="section-title">CSV Preview</h2>
      <div id="csvPreview" class="preview-container">
        <!-- CSV table will be rendered here -->
      </div>
      <button id="convertToJsonBtn" class="full-width-btn">Convert to JSON</button>
    </div>

    <div id="jsonPreviewCard" class="card" style="display:none;">
      <h2 class="section-title">JSON Preview</h2>
      <div class="muted" style="margin-bottom: 12px;">Preview of the data that will be uploaded:</div>
      <div id="jsonPreview" class="json-preview"></div>
      <button id="uploadDataBtn" class="full-width-btn">Upload Data to PureCloud</button>
    </div>

    <div id="results" class="card" style="display:none;"></div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Gamification-Upload/';
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    console.log('OAuth Configuration:');
    console.log('- Client ID:', clientId);
    console.log('- Redirect URI:', redirectUri);
    console.log('- Full OAuth URL:', oauthUrl);

    let accessToken = null;
    let selectedFile = null;
    let csvData = [];
    let jsonData = null;
    let selectedMetricId = null;

    // ===== Date Format Conversion Functions =====
    function convertToISODate(dateStr) {
      if (!dateStr) return '';
      
      // Trim and clean the date string
      dateStr = dateStr.trim();
      
      // Check if it's already in ISO format (YYYY-MM-DD)
      const isoRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (isoRegex.test(dateStr)) {
        return dateStr; // Already in correct format
      }
      
      // Try UK format (DD/MM/YYYY or DD-MM-YYYY)
      const ukRegex1 = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
      const ukRegex2 = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/; // For YY format
      
      let match = dateStr.match(ukRegex1);
      if (match) {
        const day = match[1].padStart(2, '0');
        const month = match[2].padStart(2, '0');
        const year = match[3];
        return `${year}-${month}-${day}`;
      }
      
      match = dateStr.match(ukRegex2);
      if (match) {
        const day = match[1].padStart(2, '0');
        const month = match[2].padStart(2, '0');
        const year = '20' + match[3].padStart(2, '0'); // Assuming 20xx
        return `${year}-${month}-${day}`;
      }
      
      // Try other common formats
      const usRegex = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/; // MM/DD/YYYY
      match = dateStr.match(usRegex);
      if (match) {
        const month = match[1].padStart(2, '0');
        const day = match[2].padStart(2, '0');
        const year = match[3];
        return `${year}-${month}-${day}`;
      }
      
      // If no pattern matches, return the original string
      console.warn(`Could not parse date format: "${dateStr}"`);
      return dateStr;
    }
    
    function validateISODate(dateStr) {
      if (!dateStr) return false;
      
      const isoRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (!isoRegex.test(dateStr)) return false;
      
      // Basic validation of date components
      const parts = dateStr.split('-');
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const day = parseInt(parts[2], 10);
      
      if (year < 2000 || year > 2100) return false;
      if (month < 1 || month > 12) return false;
      if (day < 1 || day > 31) return false;
      
      // More detailed validation
      const date = new Date(dateStr);
      return date instanceof Date && !isNaN(date) && 
             date.getFullYear() === year &&
             date.getMonth() + 1 === month &&
             date.getDate() === day;
    }

    // ===== Auth bootstrap =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const qparams = new URLSearchParams(window.location.search);

      const oauthError = params.get('error') || qparams.get('error');
      const oauthErrorDesc = params.get('error_description') || qparams.get('error_description');

      if (oauthError) {
        document.getElementById('auth-message').textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        document.getElementById('auth-message').className = 'error-message';
        console.error('OAuth error details:', { error: oauthError, description: oauthErrorDesc });
        return;
      }
      
      accessToken = params.get('access_token');

      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        window.location.hash = '';
        initializeApplication();
      } else if (sessionStorage.getItem('purecloud_token')) {
        accessToken = sessionStorage.getItem('purecloud_token');
        initializeApplication();
      } else {
        console.log('Initiating OAuth flow with:', { clientId, redirectUri });
        window.location.href = oauthUrl;
      }
    });
    
    function showMessage(msg, type='error'){
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success') setTimeout(()=> box.style.display='none', 5000);
    }
    
    function initializeApplication() {
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';
      
      // Load metrics
      fetchExternalMetrics();
      
      // Setup event listeners
      setupEventListeners();
    }
    
    function setupEventListeners() {
      // File upload area click
      document.getElementById('fileUploadArea').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });
      
      // File input change
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      
      // Drag and drop
      const uploadArea = document.getElementById('fileUploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary-color)';
        uploadArea.style.background = '#f0f7f4';
      });
      
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        if (!selectedFile) {
          uploadArea.style.borderColor = 'var(--border-color)';
          uploadArea.style.background = 'var(--light-bg)';
        }
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
        uploadArea.style.borderColor = selectedFile ? 'var(--primary-color)' : 'var(--border-color)';
        uploadArea.style.background = selectedFile ? '#e9f6f0' : 'var(--light-bg)';
      });
      
      // Metric select change
      document.getElementById('metric-select').addEventListener('change', (e) => {
        selectedMetricId = e.target.value;
        if (jsonData && selectedMetricId) {
          updateJsonPreview();
        }
      });
      
      // Convert to JSON button
      document.getElementById('convertToJsonBtn').addEventListener('click', convertToJson);
      
      // Upload data button
      document.getElementById('uploadDataBtn').addEventListener('click', uploadDataToPureCloud);
    }
    
    // Fetch external metrics from API
    async function fetchExternalMetrics() {
      try {
        console.log('Fetching external metrics...');
        const response = await fetch('https://api.mypurecloud.ie/api/v2/employeeperformance/externalmetrics/definitions', {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('External metrics response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        const metrics = data.entities || [];
        console.log(`Found ${metrics.length} external metrics`);
        
        const metricSelect = document.getElementById('metric-select');
        
        // Clear existing options except the first one
        while (metricSelect.options.length > 1) {
          metricSelect.remove(1);
        }
        
        // Add metric options
        metrics.forEach(metric => {
          const option = document.createElement('option');
          option.value = metric.id;
          option.textContent = `${metric.name} (${metric.unit}) ${metric.enabled ? '‚úÖ' : '‚ùå'}`;
          option.title = `Precision: ${metric.precision}, Objective: ${metric.defaultObjectiveType}`;
          metricSelect.appendChild(option);
        });
        
        if (metrics.length === 0) {
          showMessage('No external metrics found. Please create metrics in PureCloud first.', 'info');
        }
        
      } catch (error) {
        console.error('Error fetching external metrics:', error);
        showMessage(`Error loading metrics: ${error.message}`, 'error');
      }
    }
    
    // Handle file selection
    function handleFileSelect(e) {
      const file = e.target.files[0];
      handleFile(file);
    }
    
    function handleFile(file) {
      if (!file) return;
      
      // Check if it's a CSV file
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showMessage('Please select a CSV file', 'error');
        return;
      }
      
      selectedFile = file;
      
      // Update UI
      document.getElementById('fileName').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      document.getElementById('fileUploadArea').classList.add('has-file');
      
      // Read and preview CSV
      readCSVFile(file);
    }
    
    // Read CSV file
    function readCSVFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const csvText = e.target.result;
        parseCSV(csvText);
      };
      
      reader.onerror = function() {
        showMessage('Error reading file', 'error');
      };
      
      reader.readAsText(file);
    }
    
    // Parse CSV data with better handling
    function parseCSV(csvText) {
      try {
        // Handle different line endings
        const lines = csvText.split(/\r\n|\n|\r/);
        if (lines.length === 0) {
          showMessage('CSV file is empty', 'error');
          return;
        }
        
        // Get headers (first line) and clean them
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        // Parse data rows
        csvData = [];
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue; // Skip empty lines
          
          // Simple CSV parsing that handles quoted values
          const values = [];
          let inQuotes = false;
          let currentValue = '';
          
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            const nextChar = line[j + 1];
            
            if (char === '"' && !inQuotes) {
              inQuotes = true;
            } else if (char === '"' && inQuotes && nextChar === '"') {
              currentValue += '"';
              j++; // Skip next quote
            } else if (char === '"' && inQuotes) {
              inQuotes = false;
            } else if (char === ',' && !inQuotes) {
              values.push(currentValue.trim().replace(/"/g, ''));
              currentValue = '';
            } else {
              currentValue += char;
            }
          }
          
          // Add the last value
          values.push(currentValue.trim().replace(/"/g, ''));
          
          // Create row object
          const row = {};
          let hasData = false;
          
          headers.forEach((header, index) => {
            const value = values[index] || '';
            row[header] = value;
            if (value) hasData = true;
          });
          
          if (hasData) {
            csvData.push(row);
          }
        }
        
        if (csvData.length === 0) {
          showMessage('No valid data found in CSV file', 'error');
          return;
        }
        
        console.log(`Parsed ${csvData.length} rows from CSV`);
        
        // Show preview
        showCSVPreview(headers, csvData);
        
      } catch (error) {
        console.error('Error parsing CSV:', error);
        showMessage(`Error parsing CSV: ${error.message}`, 'error');
      }
    }
    
    // Show CSV preview
    function showCSVPreview(headers, data) {
      const previewDiv = document.getElementById('csvPreview');
      previewDiv.innerHTML = '';
      
      if (data.length === 0) {
        previewDiv.innerHTML = '<div class="muted">No data found in CSV file</div>';
        return;
      }
      
      // Create table
      const table = document.createElement('table');
      
      // Create header row
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create body with first 10 rows
      const tbody = document.createElement('tbody');
      const displayRows = Math.min(data.length, 10);
      for (let i = 0; i < displayRows; i++) {
        const row = document.createElement('tr');
        headers.forEach(header => {
          const td = document.createElement('td');
          const value = data[i][header] || '';
          td.textContent = value.length > 50 ? value.substring(0, 50) + '...' : value;
          td.title = value;
          row.appendChild(td);
        });
        tbody.appendChild(row);
      }
      table.appendChild(tbody);
      
      previewDiv.appendChild(table);
      
      // Show total count
      const countDiv = document.createElement('div');
      countDiv.className = 'muted';
      countDiv.style.marginTop = '12px';
      countDiv.textContent = `Showing ${displayRows} of ${data.length} rows`;
      previewDiv.appendChild(countDiv);
      
      // Show CSV preview card
      document.getElementById('csvPreviewCard').style.display = 'block';
    }
    
    // Convert CSV data to JSON
    function convertToJson() {
      const metricSelect = document.getElementById('metric-select');
      if (!metricSelect.value) {
        showMessage('Please select a metric first', 'error');
        return;
      }
      
      try {
        // Transform CSV data to the required JSON schema
        const items = [];
        let validationErrors = [];
        
        csvData.forEach((row, index) => {
          try {
            // Normalize column names (case-insensitive)
            const normalizedRow = {};
            Object.keys(row).forEach(key => {
              normalizedRow[key.toLowerCase()] = row[key];
            });
            
            // Get values with fallbacks for different column names
            const userId = normalizedRow.userid || normalizedRow.user_id || '';
            const userEmail = normalizedRow.useremail || normalizedRow.user_email || normalizedRow.email || '';
            const dateOccurredRaw = normalizedRow.dateoccurred || normalizedRow.date_occurred || normalizedRow.date || '';
            const value = normalizedRow.value || '0';
            const type = normalizedRow.type || '';
            
            // Validate required fields
            if (!userId && !userEmail) {
              throw new Error(`Row ${index + 2}: Either userId or userEmail is required`);
            }
            
            if (!dateOccurredRaw) {
              throw new Error(`Row ${index + 2}: dateOccurred is required`);
            }
            
            // Convert date format from UK (DD/MM/YYYY) to ISO (YYYY-MM-DD)
            const dateOccurredISO = convertToISODate(dateOccurredRaw);
            if (!validateISODate(dateOccurredISO)) {
              throw new Error(`Row ${index + 2}: Invalid date format. Use DD/MM/YYYY or YYYY-MM-DD. Got: "${dateOccurredRaw}"`);
            }
            
            // Validate type field
            const normalizedType = type.toLowerCase().trim();
            if (!normalizedType) {
              throw new Error(`Row ${index + 2}: type is required and must be "Total" or "Cumulative"`);
            }
            
            if (normalizedType !== 'total' && normalizedType !== 'cumulative') {
              throw new Error(`Row ${index + 2}: type must be "Total" or "Cumulative" (got: "${type}")`);
            }
            
            // Parse numeric value
            const parsedValue = parseFloat(value);
            if (isNaN(parsedValue)) {
              throw new Error(`Row ${index + 2}: value must be a number (got: "${value}")`);
            }
            
            // Create item according to the correct JSON structure
            const item = {
              metricId: metricSelect.value,
              type: type.charAt(0).toUpperCase() + type.slice(1).toLowerCase(), // Capitalize first letter
              dateOccurred: dateOccurredISO,
              value: parsedValue
            };
            
            // Add userId OR userEmail (not both required in your example)
            if (userId) {
              item.userId = userId;
            } else if (userEmail) {
              item.userEmail = userEmail;
            }
            
            // Note: count field is NOT included as it's not in your example JSON
            
            items.push(item);
            
          } catch (rowError) {
            validationErrors.push(rowError.message);
          }
        });
        
        if (validationErrors.length > 0) {
          throw new Error(`Validation errors:\n${validationErrors.join('\n')}`);
        }
        
        if (items.length === 0) {
          throw new Error('No valid data to convert');
        }
        
        jsonData = {
          items: items
        };
        
        console.log(`Converted ${items.length} rows to JSON`);
        console.log('Sample JSON item:', items[0]);
        console.log('Date conversion example:', {
          input: csvData[0].dateOccurred || csvData[0].dateoccurred || csvData[0].date,
          output: items[0].dateOccurred
        });
        
        // Update JSON preview
        updateJsonPreview();
        
        // Show JSON preview card
        document.getElementById('jsonPreviewCard').style.display = 'block';
        
        showMessage(`Successfully converted ${items.length} rows to JSON format`, 'success');
        
      } catch (error) {
        console.error('Error converting to JSON:', error);
        showMessage(`Error converting data: ${error.message}`, 'error');
      }
    }
    
    // Update JSON preview
    function updateJsonPreview() {
      if (!jsonData) return;
      
      // Create a copy to preview (limit to 5 items for preview)
      const previewData = {
        items: jsonData.items.slice(0, 5)
      };
      
      // Update metricId in preview if changed
      if (selectedMetricId) {
        previewData.items.forEach(item => {
          item.metricId = selectedMetricId;
        });
      }
      
      const jsonPreview = document.getElementById('jsonPreview');
      jsonPreview.textContent = JSON.stringify(previewData, null, 2);
      
      // Show total count
      const countInfo = document.createElement('div');
      countInfo.className = 'muted';
      countInfo.style.marginTop = '12px';
      countInfo.textContent = `Total items to upload: ${jsonData.items.length}`;
      
      // Remove existing count info if present
      const existingCount = jsonPreview.parentNode.querySelector('.muted');
      if (existingCount) {
        existingCount.remove();
      }
      
      jsonPreview.parentNode.appendChild(countInfo);
    }
    
    // Upload data to PureCloud
    async function uploadDataToPureCloud() {
      if (!jsonData || !selectedMetricId) {
        showMessage('No data to upload', 'error');
        return;
      }
      
      const button = document.getElementById('uploadDataBtn');
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = 'Uploading...';
      
      const resultsDiv = document.getElementById('results');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div class="info-message"><span class="loading"><span class="spinner"></span> Uploading data...</span></div>';
      
      try {
        // Update all items with the selected metric ID
        jsonData.items.forEach(item => {
          item.metricId = selectedMetricId;
        });
        
        console.log(`Uploading ${jsonData.items.length} items to PureCloud...`);
        console.log('Sample data being sent:', jsonData.items[0]);
        
        // Make API call
        const response = await fetch('https://api.mypurecloud.ie/api/v2/employeeperformance/externalmetrics/data', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(jsonData)
        });
        
        const data = await response.json().catch(() => ({}));
        
        if (!response.ok) {
          throw new Error(data.message || `HTTP ${response.status}: ${JSON.stringify(data)}`);
        }
        
        // Success
        resultsDiv.innerHTML = `
          <div class="success-message">
            ‚úÖ Successfully uploaded ${jsonData.items.length} metric data points!
          </div>
          <div class="muted" style="margin-top: 12px;">
            The data has been submitted to the external metrics system.
          </div>
        `;
        
        // Reset form
        resetForm();
        
      } catch (error) {
        console.error('Error uploading data:', error);
        resultsDiv.innerHTML = `
          <div class="error-message">
            ‚ùå Error uploading data: ${error.message}
          </div>
          <div class="muted" style="margin-top: 8px;">
            Please check your data and try again.
          </div>
        `;
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }
    
    // Reset form
    function resetForm() {
      selectedFile = null;
      csvData = [];
      jsonData = null;
      
      // Reset UI
      document.getElementById('fileName').textContent = '';
      document.getElementById('fileUploadArea').classList.remove('has-file');
      document.getElementById('fileInput').value = '';
      document.getElementById('csvPreviewCard').style.display = 'none';
      document.getElementById('jsonPreviewCard').style.display = 'none';
    }
  </script>
</body>
</html>
