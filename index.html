<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gamification External Metric Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1200px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}
    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}
    .file-upload-area{
      border:2px dashed var(--border-color);
      border-radius:8px;
      padding:40px 20px;
      text-align:center;
      background:var(--light-bg);
      cursor:pointer;
      transition:border-color .2s, background .2s;
    }
    .file-upload-area:hover{
      border-color:var(--primary-color);
      background:#f0f7f4;
    }
    .file-upload-area.has-file{
      border-color:var(--primary-color);
      background:#e9f6f0;
    }
    .upload-icon{
      font-size:48px;
      color:var(--primary-color);
      margin-bottom:12px;
    }
    .file-name{
      margin-top:12px;
      font-weight:600;
      color:var(--primary-color);
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
    }
    th, td{
      border:1px solid var(--border-color);
      padding:10px;
      text-align:left;
    }
    th{
      background:var(--light-bg);
      font-weight:600;
    }
    tr:nth-child(even){
      background:#fafafa;
    }
    .preview-container{
      max-height:400px;
      overflow:auto;
      margin-top:16px;
    }
    .json-preview{
      background:#f8f9fa;
      border:1px solid var(--border-color);
      border-radius:6px;
      padding:16px;
      font-family:monospace;
      font-size:12px;
      white-space:pre-wrap;
      max-height:400px;
      overflow:auto;
    }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading { display: flex; align-items: center; gap: 8px; }
    .help-text { background: #f8f9fa; border-left: 3px solid var(--primary-color); padding: 12px; margin: 12px 0; font-size: 14px; }
    .help-text ul { margin: 8px 0; padding-left: 20px; }
    .help-text li { margin-bottom: 4px; }
    .date-format-info { background: #e9f6f0; border: 1px solid var(--primary-color); border-radius: 6px; padding: 12px; margin: 12px 0; font-size: 14px; }
    .example-csv-section { background: #e9f6f0; border: 1px solid var(--primary-color); border-radius: 6px; padding: 16px; margin: 16px 0; }
    .example-csv-section h3 { margin-top: 0; color: var(--secondary-color); }
    .example-csv-section code { background: #fff; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; border: 1px solid var(--border-color); }
    .example-csv-table { width: 100%; margin: 12px 0; font-size: 12px; }
    .example-csv-table th, .example-csv-table td { padding: 6px; border: 1px solid #ccc; text-align: left; }
    .example-csv-table th { background: #f0f7f4; }
    .btn-secondary { background: #6c757d; border-color: #6c757d; }
    .btn-secondary:hover { background: #5a6268; border-color: #545b62; }
    .action-buttons { display: flex; gap: 12px; margin-top: 12px; }
    .warning-note { background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin: 12px 0; font-size: 14px; color: #856404; }
  </style>
</head>

<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>Gamification External Metric Upload</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <!-- Example CSV Section -->
    <div class="card">
      <h2 class="section-title">Example CSV Format</h2>
      <div class="example-csv-section">
        <p>Download an example CSV file to ensure your data is in the correct format:</p>

        <table class="example-csv-table">
          <thead>
            <tr>
              <th>UserID</th>
              <th>UserEmail</th>
              <th>DateOccurred</th>
              <th>Value</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>08377fd8-3680-4a50-b909-c685e1567659</td>
              <td>john.doe@company.com</td>
              <td>03/12/2025</td>
              <td>95</td>
              <td>total</td>
            </tr>
            <tr>
              <td>1a2b3c4d-5678-90ef-ghij-klmnopqrstuv</td>
              <td>jane.smith@company.com</td>
              <td>2025-12-02</td>
              <td>42.5</td>
              <td>cumulative</td>
            </tr>
            <tr>
              <td></td>
              <td>mike.jones@company.com</td>
              <td>02/12/2025</td>
              <td>100</td>
              <td>total</td>
            </tr>
          </tbody>
        </table>

        <div class="action-buttons">
          <button id="downloadExampleBtn" class="btn-secondary">üì• Download Example CSV</button>
          <button id="copyExampleBtn" class="btn-secondary">üìã Copy CSV Format</button>
        </div>

        <div class="muted" style="margin-top: 12px;">
          Save your CSV in UTF-8 format for best compatibility
        </div>
      </div>
    </div>

    <!-- Metric Select -->
    <div class="card">
      <h2 class="section-title">Select Metric</h2>
      <div class="controls">
        <div>
          <label for="metric-select">External Metric</label>
          <select id="metric-select">
            <option value="">Select a metric...</option>
          </select>
          <div class="muted">Choose the metric to upload data for</div>
        </div>
      </div>
    </div>

    <!-- CSV Upload -->
    <div class="card">
      <h2 class="section-title">Upload CSV File</h2>
      <div class="date-format-info">
        <strong>CSV Format Requirements:</strong>
        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
          <li>Your CSV should have 5 header columns: UserID, UserEmail, DateOccurred, Value, Type</li>
          <li>Date can be UK format (DD/MM/YYYY) or ISO format (YYYY-MM-DD)</li>
          <li>Either UserID OR Email Address required</li>
        </ul>
      </div>

      <div class="warning-note">
        <strong>‚ö†Ô∏è Important:</strong> Ensure your CSV has separate columns (not all data in one column).
      </div>

      <div id="fileUploadArea" class="file-upload-area">
        <div class="upload-icon">üìÅ</div>
        <div><strong>Click to upload CSV file</strong></div>
        <div class="muted" style="margin-top: 8px;">or drag and drop your file here</div>
      </div>
      <input type="file" id="fileInput" accept=".csv" style="display:none" />
      <div id="fileName" class="file-name"></div>
    </div>

    <div id="csvPreviewCard" class="card" style="display:none;">
      <h2 class="section-title">CSV Preview</h2>
      <div id="csvPreview" class="preview-container"></div>
      <button id="convertToJsonBtn" class="full-width-btn">Convert to JSON</button>
    </div>

    <div id="jsonPreviewCard" class="card" style="display:none;">
      <h2 class="section-title">JSON Preview</h2>
      <div id="jsonPreview" class="json-preview"></div>
      <button id="uploadDataBtn" class="full-width-btn">Upload Data to PureCloud</button>
    </div>

    <div id="results" class="card" style="display:none;"></div>
  </div>

<script>
/* =========================================================================
   ‚úî UPDATED EXAMPLE CSV ‚Äî SEMICOLON DELIMITED (Excel UK-friendly)
   ========================================================================= */
const exampleCSV = `UserID;UserEmail;DateOccurred;Value;Type
08377fd8-3680-4a50-b909-c685e1567659;john.doe@company.com;03/12/2025;95;total
1a2b3c4d-5678-90ef-ghij-klmnopqrstuv;jane.smith@company.com;2025-12-02;42.5;cumulative
;mike.jones@company.com;02/12/2025;100;total
abc12345-6789-1011-1213-141516171819;sarah.wilson@company.com;01/12/2025;75;total
;admin@company.com;2025-11-30;50.25;cumulative`;

/* =========================================================================
   ‚úî FIXED CSV DOWNLOAD ‚Äî RELIABLE + EXCEL OPENS IN COLUMNS
   ========================================================================= */
function downloadExampleCSV() {
  try {
    // Add UTF-8 BOM for better Excel compatibility
    const BOM = '\uFEFF';
    const csvWithBOM = BOM + exampleCSV;
    
    const blob = new Blob([csvWithBOM], { 
      type: 'text/csv;charset=utf-8;' 
    });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = 'gamification_example.csv';
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    URL.revokeObjectURL(url);

    showMessage('Example CSV file downloaded successfully! It will open in separate columns in Excel.', 'success');
  } catch (error) {
    console.error('Error downloading CSV:', error);
    showMessage('Error downloading example CSV. Please try again.', 'error');
  }
}

/* =========================================================================
   ‚úî FIXED COPY-TO-CLIPBOARD ‚Äî ONLY COPIES CSV TEXT
   ========================================================================= */
function copyExampleFormat() {
  // Create a temporary textarea element
  const textarea = document.createElement('textarea');
  textarea.value = exampleCSV;
  textarea.style.position = 'fixed';
  textarea.style.left = '-9999px';
  textarea.style.top = '-9999px';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  
  // Select and copy
  textarea.select();
  textarea.setSelectionRange(0, 99999); // For mobile devices

  try {
    // Try using the newer clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(exampleCSV)
        .then(() => {
          showMessage('CSV format copied to clipboard! Paste into Excel for separate columns.', 'success');
          document.body.removeChild(textarea);
        })
        .catch(() => {
          // Fallback to execCommand
          const success = document.execCommand('copy');
          if (success) {
            showMessage('CSV format copied to clipboard! Paste into Excel for separate columns.', 'success');
          } else {
            showMessage('Unable to copy CSV. Please copy manually from the example table above.', 'error');
          }
          document.body.removeChild(textarea);
        });
    } else {
      // Fallback for older browsers
      const success = document.execCommand('copy');
      if (success) {
        showMessage('CSV format copied to clipboard! Paste into Excel for separate columns.', 'success');
      } else {
        showMessage('Unable to copy CSV. Please copy manually from the example table above.', 'error');
      }
      document.body.removeChild(textarea);
    }
  } catch (err) {
    document.body.removeChild(textarea);
    showMessage('Unable to copy CSV. Please copy manually from the example table above.', 'error');
  }
}

// Message display function
function showMessage(message, type) {
  const messageContainer = document.getElementById('messageContainer');
  messageContainer.innerHTML = '';
  messageContainer.style.display = 'block';
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `${type}-message`;
  messageDiv.innerHTML = message;
  messageContainer.appendChild(messageDiv);
  
  // Auto-hide success messages after 5 seconds
  if (type === 'success') {
    setTimeout(() => {
      messageContainer.style.display = 'none';
    }, 5000);
  }
}

/* =========================================================================
   GLOBAL VARIABLES
   ========================================================================= */
let accessToken = null;
let selectedFile = null;
let csvData = [];
let jsonData = null;
let selectedMetricId = null;

/* =========================================================================
   INITIALIZATION
   ========================================================================= */
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing...');
  
  // Add event listeners for example CSV buttons
  const downloadBtn = document.getElementById('downloadExampleBtn');
  const copyBtn = document.getElementById('copyExampleBtn');
  
  if (downloadBtn) {
    console.log('Adding download button listener');
    downloadBtn.addEventListener('click', downloadExampleCSV);
  } else {
    console.error('Download button not found!');
  }
  
  if (copyBtn) {
    console.log('Adding copy button listener');
    copyBtn.addEventListener('click', copyExampleFormat);
  } else {
    console.error('Copy button not found!');
  }
  
  // Initialize the rest of the app
  initializeApp();
});

// Date conversion functions
function convertToISODate(dateStr) {
  // Try UK format (DD/MM/YYYY)
  const ukMatch = dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (ukMatch) {
    const [_, day, month, year] = ukMatch;
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
  }
  
  // Try ISO format (YYYY-MM-DD)
  const isoMatch = dateStr.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (isoMatch) {
    const [_, year, month, day] = isoMatch;
    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
  }
  
  return dateStr; // Return as-is if no match
}

function validateISODate(dateStr) {
  return /^\d{4}-\d{2}-\d{2}$/.test(dateStr);
}

// Initialize the application
function initializeApp() {
  console.log('Initializing app...');
  
  // Add file upload event listeners
  const fileUploadArea = document.getElementById('fileUploadArea');
  const fileInput = document.getElementById('fileInput');
  
  if (fileUploadArea && fileInput) {
    fileUploadArea.addEventListener('click', () => {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', handleFileSelect);
    
    // Add drag and drop support
    fileUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUploadArea.style.borderColor = 'var(--primary-color)';
      fileUploadArea.style.background = '#f0f7f4';
    });
    
    fileUploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      if (!fileUploadArea.classList.contains('has-file')) {
        fileUploadArea.style.borderColor = 'var(--border-color)';
        fileUploadArea.style.background = 'var(--light-bg)';
      }
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUploadArea.style.borderColor = 'var(--primary-color)';
      fileUploadArea.style.background = '#e9f6f0';
      
      const file = e.dataTransfer.files[0];
      if (file) {
        handleFile(file);
      }
    });
  }
  
  // Add event listeners for buttons
  const convertBtn = document.getElementById('convertToJsonBtn');
  const uploadBtn = document.getElementById('uploadDataBtn');
  const metricSelect = document.getElementById('metric-select');
  
  if (convertBtn) {
    convertBtn.addEventListener('click', convertToJson);
  }
  
  if (uploadBtn) {
    uploadBtn.addEventListener('click', uploadDataToPureCloud);
  }
  
  if (metricSelect) {
    metricSelect.addEventListener('change', function() {
      selectedMetricId = this.value;
    });
  }
  
  // For demo purposes, simulate authentication
  setTimeout(() => {
    const authCard = document.getElementById('authCard');
    const appContent = document.getElementById('appContent');
    
    if (authCard && appContent) {
      authCard.style.display = 'none';
      appContent.style.display = 'block';
      console.log('App content displayed');
    }
  }, 1000);
}

// Handle file selection
function handleFileSelect(e) {
  const file = e.target.files[0];
  handleFile(file);
}

function handleFile(file) {
  if (!file) return;
  
  // Check if it's a CSV file
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showMessage('Please select a CSV file', 'error');
    return;
  }
  
  selectedFile = file;
  
  // Update UI
  document.getElementById('fileName').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
  document.getElementById('fileUploadArea').classList.add('has-file');
  
  // Read and preview CSV
  readCSVFile(file);
}

// Read CSV file
function readCSVFile(file) {
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const csvText = e.target.result;
    parseCSV(csvText);
  };
  
  reader.onerror = function() {
    showMessage('Error reading file', 'error');
  };
  
  reader.readAsText(file);
}

// ULTRA ROBUST CSV PARSER - specifically for your Excel-style CSV
function parseCSV(csvText) {
  try {
    // Log raw input for debugging
    console.log('Raw CSV text first 500 chars:', csvText.substring(0, 500));
    
    // Handle BOM and different line endings
    let text = csvText;
    
    // Remove BOM if present
    if (text.charCodeAt(0) === 0xFEFF || text.charCodeAt(0) === 0xFFFE) {
      text = text.substring(1);
    }
    
    // Replace different line endings with \n
    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    
    const lines = text.split('\n');
    console.log('Total lines found:', lines.length);
    
    if (lines.length === 0) {
      showMessage('CSV file is empty', 'error');
      return;
    }
    
    // Find first non-empty line for headers
    let headerLineIndex = 0;
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].trim().length > 0) {
        headerLineIndex = i;
        break;
      }
    }
    
    // Get the header line
    const headerLine = lines[headerLineIndex];
    console.log('Header line raw:', headerLine);
    
    // SPECIAL FIX: Check delimiter - if semicolon is used, split by semicolon
    let headers = [];
    if (headerLine.includes(';')) {
      headers = headerLine.split(';').map(h => h.trim());
    } else if (headerLine.includes('"')) {
      // Handle quoted headers
      headers = headerLine.match(/(?:[^,"]+|"[^"]*")+/g) || [];
      headers = headers.map(h => h.replace(/^"|"$/g, '').trim());
    } else {
      // Simple split for unquoted headers
      headers = headerLine.split(',').map(h => h.trim());
    }
    
    // Clean up headers - remove any empty ones
    headers = headers.filter(h => h.length > 0);
    
    console.log('Headers found:', headers);
    console.log('Number of headers:', headers.length);
    
    // Parse data rows
    csvData = [];
    
    for (let i = headerLineIndex + 1; i < lines.length; i++) {
      const line = lines[i].trim();
      
      // Skip empty lines
      if (!line || line === '' || line.replace(/[;,]/g, '').trim().length === 0) {
        continue;
      }
      
      console.log(`Processing line ${i}:`, line);
      
      let values = [];
      
      // Check delimiter used in data row
      if (line.includes(';')) {
        values = line.split(';').map(v => v.trim());
      } else if (line.includes('"')) {
        // Handle quoted values
        values = line.match(/(?:[^,"]+|"[^"]*")+/g) || [];
        values = values.map(v => v.replace(/^"|"$/g, '').trim());
      } else {
        // Simple split for unquoted values
        values = line.split(',').map(v => v.trim());
      }
      
      // Ensure we have enough values for all headers
      while (values.length < headers.length) {
        values.push('');
      }
      
      // Create row object
      const row = {};
      let hasData = false;
      
      for (let j = 0; j < headers.length; j++) {
        const header = headers[j];
        const value = values[j] || '';
        row[header] = value;
        
        if (value && value.trim().length > 0) {
          hasData = true;
        }
      }
      
      // Log the parsed row for debugging
      console.log(`Row ${csvData.length + 1}:`, row);
      
      if (hasData) {
        csvData.push(row);
      }
    }
    
    if (csvData.length === 0) {
      showMessage('No valid data found in CSV file. Please ensure your CSV has data rows.', 'error');
      return;
    }
    
    console.log(`Successfully parsed ${csvData.length} valid rows from CSV`);
    console.log('First row data:', csvData[0]);
    
    // Show preview
    showCSVPreview(headers, csvData);
    
  } catch (error) {
    console.error('Error parsing CSV:', error);
    showMessage(`Error parsing CSV: ${error.message}. Please ensure your CSV is properly formatted.`, 'error');
  }
}

// Show CSV preview
function showCSVPreview(headers, data) {
  const previewDiv = document.getElementById('csvPreview');
  if (!previewDiv) return;
  
  previewDiv.innerHTML = '';
  
  if (data.length === 0) {
    previewDiv.innerHTML = '<div class="muted">No data found in CSV file</div>';
    return;
  }
  
  // Create table
  const table = document.createElement('table');
  
  // Create header row
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headers.forEach(header => {
    const th = document.createElement('th');
    th.textContent = header;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  // Create body with first 10 rows
  const tbody = document.createElement('tbody');
  const displayRows = Math.min(data.length, 10);
  for (let i = 0; i < displayRows; i++) {
    const row = document.createElement('tr');
    headers.forEach(header => {
      const td = document.createElement('td');
      const value = data[i][header] || '';
      td.textContent = value.length > 50 ? value.substring(0, 50) + '...' : value;
      td.title = value;
      row.appendChild(td);
    });
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  
  previewDiv.appendChild(table);
  
  // Show total count
  const countDiv = document.createElement('div');
  countDiv.className = 'muted';
  countDiv.style.marginTop = '12px';
  countDiv.textContent = `Showing ${displayRows} of ${data.length} rows`;
  previewDiv.appendChild(countDiv);
  
  // Show CSV preview card
  const csvPreviewCard = document.getElementById('csvPreviewCard');
  if (csvPreviewCard) {
    csvPreviewCard.style.display = 'block';
  }
}

// Convert CSV data to JSON - UPDATED TO HANDLE MISSPELLED "DateOccured"
function convertToJson() {
  const metricSelect = document.getElementById('metric-select');
  if (!metricSelect || !metricSelect.value) {
    showMessage('Please select a metric first', 'error');
    return;
  }
  
  try {
    // Transform CSV data to the required JSON schema
    const items = [];
    let validationErrors = [];
    
    console.log('Converting CSV to JSON. CSV data:', csvData);
    
    csvData.forEach((row, index) => {
      try {
        // Log the row being processed
        console.log(`Processing row ${index}:`, row);
        
        // Normalize column names (case-insensitive)
        const normalizedRow = {};
        Object.keys(row).forEach(key => {
          normalizedRow[key.toLowerCase()] = row[key];
        });
        
        console.log(`Normalized row ${index}:`, normalizedRow);
        
        // Get values with fallbacks for different column names
        const userId = normalizedRow.userid || normalizedRow.user_id || '';
        const userEmail = normalizedRow.useremail || normalizedRow.user_email || normalizedRow.email || '';
        
        // FIX: Handle both "dateoccurred" (correct) and "dateoccured" (misspelled)
        const dateOccurredRaw = normalizedRow.dateoccurred || normalizedRow.dateoccured || normalizedRow.date_occurred || normalizedRow.date || '';
        
        const value = normalizedRow.value || '0';
        const type = normalizedRow.type || '';
        
        console.log(`Row ${index} values:`, { userId, userEmail, dateOccurredRaw, value, type });
        
        // Validate required fields
        if (!userId && !userEmail) {
          throw new Error(`Row ${index + 2}: Either UserID or UserEmail is required`);
        }
        
        if (!dateOccurredRaw) {
          throw new Error(`Row ${index + 2}: DateOccurred is required. Found columns: ${Object.keys(normalizedRow).join(', ')}`);
        }
        
        // Convert date format from UK (DD/MM/YYYY) to ISO (YYYY-MM-DD)
        const dateOccurredISO = convertToISODate(dateOccurredRaw);
        console.log(`Row ${index} date conversion: "${dateOccurredRaw}" -> "${dateOccurredISO}"`);
        
        if (!validateISODate(dateOccurredISO)) {
          throw new Error(`Row ${index + 2}: Invalid date format. Use DD/MM/YYYY or YYYY-MM-DD. Got: "${dateOccurredRaw}"`);
        }
        
        // Validate type field
        const normalizedType = type.toLowerCase().trim();
        if (!normalizedType) {
          throw new Error(`Row ${index + 2}: Type is required and must be "Total" or "Cumulative"`);
        }
        
        if (normalizedType !== 'total' && normalizedType !== 'cumulative') {
          throw new Error(`Row ${index + 2}: Type must be "Total" or "Cumulative" (got: "${type}")`);
        }
        
        // Parse numeric value
        const parsedValue = parseFloat(value);
        if (isNaN(parsedValue)) {
          throw new Error(`Row ${index + 2}: Value must be a number (got: "${value}")`);
        }
        
        // Create item according to the correct JSON structure
        const item = {
          metricId: metricSelect.value,
          type: type.charAt(0).toUpperCase() + type.slice(1).toLowerCase(), // Capitalize first letter
          dateOccurred: dateOccurredISO,
          value: parsedValue
        };
        
        // Add userId OR userEmail (not both required in your example)
        if (userId) {
          item.userId = userId;
        } else if (userEmail) {
          item.userEmail = userEmail;
        }
        
        console.log(`Created item for row ${index}:`, item);
        items.push(item);
        
      } catch (rowError) {
        console.error(`Error in row ${index}:`, rowError.message);
        validationErrors.push(rowError.message);
      }
    });
    
    if (validationErrors.length > 0) {
      throw new Error(`Validation errors:\n${validationErrors.join('\n')}`);
    }
    
    if (items.length === 0) {
      throw new Error('No valid data to convert');
    }
    
    jsonData = {
      items: items
    };
    
    console.log(`Converted ${items.length} rows to JSON`);
    console.log('Sample JSON item:', items[0]);
    
    // Update JSON preview
    updateJsonPreview();
    
    // Show JSON preview card
    const jsonPreviewCard = document.getElementById('jsonPreviewCard');
    if (jsonPreviewCard) {
      jsonPreviewCard.style.display = 'block';
    }
    
    showMessage(`Successfully converted ${items.length} rows to JSON format`, 'success');
    
  } catch (error) {
    console.error('Error converting to JSON:', error);
    showMessage(`Error converting data: ${error.message}`, 'error');
  }
}

// Update JSON preview
function updateJsonPreview() {
  if (!jsonData) return;
  
  const jsonPreview = document.getElementById('jsonPreview');
  if (!jsonPreview) return;
  
  // Create a copy to preview (limit to 5 items for preview)
  const previewData = {
    items: jsonData.items.slice(0, 5)
  };
  
  // Update metricId in preview if changed
  if (selectedMetricId) {
    previewData.items.forEach(item => {
      item.metricId = selectedMetricId;
    });
  }
  
  jsonPreview.textContent = JSON.stringify(previewData, null, 2);
  
  // Show total count
  const countInfo = document.createElement('div');
  countInfo.className = 'muted';
  countInfo.style.marginTop = '12px';
  countInfo.textContent = `Total items to upload: ${jsonData.items.length}`;
  
  // Remove existing count info if present
  const existingCount = jsonPreview.parentNode.querySelector('.muted');
  if (existingCount) {
    existingCount.remove();
  }
  
  jsonPreview.parentNode.appendChild(countInfo);
}

// Upload data to PureCloud
async function uploadDataToPureCloud() {
  if (!jsonData || !selectedMetricId) {
    showMessage('No data to upload', 'error');
    return;
  }
  
  const button = document.getElementById('uploadDataBtn');
  if (!button) return;
  
  button.disabled = true;
  const originalText = button.textContent;
  button.textContent = 'Uploading...';
  
  const resultsDiv = document.getElementById('results');
  if (resultsDiv) {
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="info-message"><span class="loading"><span class="spinner"></span> Uploading data...</span></div>';
  }
  
  try {
    // Update all items with the selected metric ID
    jsonData.items.forEach(item => {
      item.metricId = selectedMetricId;
    });
    
    console.log(`Uploading ${jsonData.items.length} items to PureCloud...`);
    console.log('Sample data being sent:', jsonData.items[0]);
    
    // Make API call
    const response = await fetch('https://api.mypurecloud.ie/api/v2/employeeperformance/externalmetrics/data', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(jsonData)
    });
    
    const data = await response.json().catch(() => ({}));
    
    if (!response.ok) {
      throw new Error(data.message || `HTTP ${response.status}: ${JSON.stringify(data)}`);
    }
    
    // Success
    if (resultsDiv) {
      resultsDiv.innerHTML = `
        <div class="success-message">
          ‚úÖ Successfully uploaded ${jsonData.items.length} metric data points!
        </div>
        <div class="warning-note" style="margin-top: 12px;">
          <strong>‚ö†Ô∏è Important:</strong> Data has been submitted to Genesys and cannot be reverted.
        </div>
      `;
    }
    
    // Reset form
    resetForm();
    
  } catch (error) {
    console.error('Error uploading data:', error);
    if (resultsDiv) {
      resultsDiv.innerHTML = `
        <div class="error-message">
          ‚ùå Error uploading data: ${error.message}
        </div>
        <div class="muted" style="margin-top: 8px;">
          Please check your data and try again.
        </div>
      `;
    }
  } finally {
    button.disabled = false;
    button.textContent = originalText;
  }
}

// Reset form
function resetForm() {
  selectedFile = null;
  csvData = [];
  jsonData = null;
  
  // Reset UI
  const fileName = document.getElementById('fileName');
  const fileUploadArea = document.getElementById('fileUploadArea');
  const fileInput = document.getElementById('fileInput');
  const csvPreviewCard = document.getElementById('csvPreviewCard');
  const jsonPreviewCard = document.getElementById('jsonPreviewCard');
  
  if (fileName) fileName.textContent = '';
  if (fileUploadArea) fileUploadArea.classList.remove('has-file');
  if (fileInput) fileInput.value = '';
  if (csvPreviewCard) csvPreviewCard.style.display = 'none';
  if (jsonPreviewCard) jsonPreviewCard.style.display = 'none';
}
</script>
</body>
</html>
