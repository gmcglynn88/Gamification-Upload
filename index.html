<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gamification External Metric Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    /* ... (keep all your existing CSS styles exactly as they are) ... */
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>Gamification External Metric Upload</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
    <div id="auth-debug" style="display:none; margin-top:10px; padding:10px; background:#f8f9fa; border-radius:6px; font-size:12px; font-family:monospace;"></div>
  </div>

  <div id="appContent" style="display:none;">
    <!-- ... (keep all your existing HTML content exactly as it is) ... -->
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    // Try both redirect URIs - one for local dev, one for GitHub Pages
    const redirectUri = window.location.href.includes('localhost') 
      ? 'http://localhost:5500/'  // For local testing
      : 'https://gmcglynn88.github.io/Gamification-Upload/';  // For GitHub Pages
      
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    console.log('OAuth Configuration:');
    console.log('- Client ID:', clientId);
    console.log('- Redirect URI:', redirectUri);
    console.log('- Current URL:', window.location.href);
    console.log('- Full OAuth URL:', oauthUrl);

    let accessToken = null;
    let selectedFile = null;
    let csvData = [];
    let jsonData = null;
    let selectedMetricId = null;

    // ===== Example CSV Data =====
    const exampleCSV = `UserID,UserEmail,DateOccurred,Value,Type
08377fd8-3680-4a50-b909-c685e1567659,john.doe@company.com,03/12/2025,95,total
1a2b3c4d-5678-90ef-ghij-klmnopqrstuv,jane.smith@company.com,2025-12-02,42.5,cumulative
,mike.jones@company.com,02/12/2025,100,total
abc12345-6789-1011-1213-141516171819,sarah.wilson@company.com,01/12/2025,75,total
,admin@company.com,2025-11-30,50.25,cumulative`;

    // ===== Enhanced OAuth Handler =====
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, checking for OAuth response...');
      
      const debugDiv = document.getElementById('auth-debug');
      debugDiv.style.display = 'block';
      debugDiv.innerHTML = `
        <strong>Debug Info:</strong><br>
        URL: ${window.location.href}<br>
        Hash: ${window.location.hash}<br>
        Search: ${window.location.search}<br>
        Redirect URI: ${redirectUri}
      `;

      // Check URL hash for OAuth response
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      
      console.log('Hash params:', Object.fromEntries(params.entries()));
      
      const access_token = params.get('access_token');
      const error = params.get('error');
      const error_description = params.get('error_description');

      if (error) {
        console.error('OAuth error:', error, error_description);
        document.getElementById('auth-message').textContent = `OAuth Error: ${error_description || error}`;
        document.getElementById('auth-message').className = 'error-message';
        debugDiv.innerHTML += `<br><strong style="color:red">OAuth Error: ${error} - ${error_description}</strong>`;
        return;
      }

      if (access_token) {
        console.log('Access token found in URL hash');
        accessToken = access_token;
        sessionStorage.setItem('purecloud_token', accessToken);
        
        // Clear the hash from URL
        window.location.hash = '';
        
        debugDiv.innerHTML += `<br><strong style="color:green">Token found! Length: ${accessToken.length} chars</strong>`;
        document.getElementById('auth-message').textContent = 'Token received, initializing application...';
        
        // Initialize app
        setTimeout(() => initializeApplication(), 500);
      } else if (sessionStorage.getItem('purecloud_token')) {
        console.log('Using token from sessionStorage');
        accessToken = sessionStorage.getItem('purecloud_token');
        debugDiv.innerHTML += `<br><strong style="color:green">Using cached token from sessionStorage</strong>`;
        initializeApplication();
      } else {
        console.log('No token found, initiating OAuth flow');
        debugDiv.innerHTML += `<br><strong style="color:orange">No token found, redirecting to OAuth...</strong>`;
        document.getElementById('auth-message').textContent = 'Redirecting to PureCloud login...';
        
        // Give user a moment to see the message before redirect
        setTimeout(() => {
          window.location.href = oauthUrl;
        }, 1000);
      }
    });

    // ===== Date Format Conversion Functions =====
    function convertToISODate(dateStr) {
      if (!dateStr) return '';
      
      // Trim and clean the date string
      dateStr = dateStr.trim();
      
      // Check if it's already in ISO format (YYYY-MM-DD)
      const isoRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (isoRegex.test(dateStr)) {
        return dateStr; // Already in correct format
      }
      
      // Try UK format (DD/MM/YYYY or DD-MM-YYYY)
      const ukRegex1 = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
      const ukRegex2 = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/; // For YY format
      
      let match = dateStr.match(ukRegex1);
      if (match) {
        const day = match[1].padStart(2, '0');
        const month = match[2].padStart(2, '0');
        const year = match[3];
        return `${year}-${month}-${day}`;
      }
      
      match = dateStr.match(ukRegex2);
      if (match) {
        const day = match[1].padStart(2, '0');
        const month = match[2].padStart(2, '0');
        const year = '20' + match[3].padStart(2, '0'); // Assuming 20xx
        return `${year}-${month}-${day}`;
      }
      
      // Try other common formats
      const usRegex = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/; // MM/DD/YYYY
      match = dateStr.match(usRegex);
      if (match) {
        const month = match[1].padStart(2, '0');
        const day = match[2].padStart(2, '0');
        const year = match[3];
        return `${year}-${month}-${day}`;
      }
      
      // If no pattern matches, return the original string
      console.warn(`Could not parse date format: "${dateStr}"`);
      return dateStr;
    }
    
    function validateISODate(dateStr) {
      if (!dateStr) return false;
      
      const isoRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (!isoRegex.test(dateStr)) return false;
      
      // Basic validation of date components
      const parts = dateStr.split('-');
      const year = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10);
      const day = parseInt(parts[2], 10);
      
      if (year < 2000 || year > 2100) return false;
      if (month < 1 || month > 12) return false;
      if (day < 1 || day > 31) return false;
      
      // More detailed validation
      const date = new Date(dateStr);
      return date instanceof Date && !isNaN(date) && 
             date.getFullYear() === year &&
             date.getMonth() + 1 === month &&
             date.getDate() === day;
    }

    function showMessage(msg, type='error'){
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success') setTimeout(()=> box.style.display='none', 5000);
    }
    
    function initializeApplication() {
      console.log('Initializing application with token:', accessToken ? 'Token present' : 'No token');
      
      if (!accessToken) {
        console.error('No access token available!');
        showMessage('Authentication failed. Please refresh the page to try again.', 'error');
        return;
      }
      
      document.getElementById('auth-message').textContent = 'Authenticated successfully! Loading metrics...';
      setTimeout(() => {
        document.getElementById('authCard').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        
        // Load metrics
        fetchExternalMetrics();
        
        // Setup event listeners
        setupEventListeners();
      }, 1000);
    }
    
    function setupEventListeners() {
      // Example CSV download button
      document.getElementById('downloadExampleBtn').addEventListener('click', function() {
        downloadExampleCSV();
      });
      
      document.getElementById('copyExampleBtn').addEventListener('click', function() {
        copyExampleFormat();
      });
      
      // File upload area click
      document.getElementById('fileUploadArea').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });
      
      // File input change
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      
      // Drag and drop
      const uploadArea = document.getElementById('fileUploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary-color)';
        uploadArea.style.background = '#f0f7f4';
      });
      
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        if (!selectedFile) {
          uploadArea.style.borderColor = 'var(--border-color)';
          uploadArea.style.background = 'var(--light-bg)';
        }
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
        uploadArea.style.borderColor = selectedFile ? 'var(--primary-color)' : 'var(--border-color)';
        uploadArea.style.background = selectedFile ? '#e9f6f0' : 'var(--light-bg)';
      });
      
      // Metric select change
      document.getElementById('metric-select').addEventListener('change', (e) => {
        selectedMetricId = e.target.value;
        console.log('Selected metric:', selectedMetricId);
        if (jsonData && selectedMetricId) {
          updateJsonPreview();
        }
      });
      
      // Convert to JSON button
      document.getElementById('convertToJsonBtn').addEventListener('click', convertToJson);
      
      // Upload data button
      document.getElementById('uploadDataBtn').addEventListener('click', uploadDataToPureCloud);
    }
    
    // Download example CSV file
    function downloadExampleCSV() {
      try {
        const blob = new Blob([exampleCSV], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'gamification_example.csv';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        showMessage('Example CSV file downloaded successfully!', 'success');
      } catch (error) {
        console.error('Error downloading CSV:', error);
        showMessage('Error downloading example CSV. Please try again.', 'error');
      }
    }
    
    // Copy example format to clipboard
    function copyExampleFormat() {
      const textArea = document.createElement('textarea');
      textArea.value = exampleCSV;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showMessage('CSV format copied to clipboard!', 'success');
        } else {
          throw new Error('Copy command failed');
        }
      } catch (err) {
        console.error('Failed to copy: ', err);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(exampleCSV)
            .then(() => {
              showMessage('CSV format copied to clipboard!', 'success');
            })
            .catch(clipboardErr => {
              console.error('Clipboard API error: ', clipboardErr);
              showMessage('Failed to copy to clipboard. Please manually select and copy the example table.', 'error');
            });
        } else {
          showMessage('Failed to copy to clipboard. Please manually select and copy the example table.', 'error');
        }
      } finally {
        document.body.removeChild(textArea);
      }
    }
    
    // Fetch external metrics from API - FIXED with better error handling
    async function fetchExternalMetrics() {
      try {
        console.log('Fetching external metrics with token:', accessToken ? 'Token exists' : 'No token');
        
        if (!accessToken) {
          throw new Error('No access token available. Please authenticate first.');
        }
        
        // Test the token first with a simple API call
        const testResponse = await fetch('https://api.mypurecloud.ie/api/v2/authorization/me', {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!testResponse.ok) {
          const errorText = await testResponse.text();
          console.error('Token test failed:', testResponse.status, errorText);
          
          if (testResponse.status === 401) {
            // Token is invalid, clear it and restart auth
            sessionStorage.removeItem('purecloud_token');
            showMessage('Session expired. Please refresh the page to re-authenticate.', 'error');
            return;
          }
          
          throw new Error(`Token validation failed: HTTP ${testResponse.status}`);
        }
        
        console.log('Token is valid, fetching metrics...');
        
        const response = await fetch('https://api.mypurecloud.ie/api/v2/employeeperformance/externalmetrics/definitions', {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('Metrics response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Metrics API error:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        const metrics = data.entities || [];
        console.log(`Found ${metrics.length} external metrics:`, metrics);
        
        const metricSelect = document.getElementById('metric-select');
        
        // Clear existing options except the first one
        while (metricSelect.options.length > 1) {
          metricSelect.remove(1);
        }
        
        // Add metric options
        metrics.forEach(metric => {
          const option = document.createElement('option');
          option.value = metric.id;
          option.textContent = `${metric.name} (${metric.unit}) ${metric.enabled ? '✅' : '❌'}`;
          option.title = `Precision: ${metric.precision}, Objective: ${metric.defaultObjectiveType}`;
          metricSelect.appendChild(option);
        });
        
        if (metrics.length === 0) {
          showMessage('No external metrics found. Please create metrics in PureCloud first.', 'info');
        } else {
          showMessage(`Loaded ${metrics.length} metrics successfully.`, 'success');
        }
        
      } catch (error) {
        console.error('Error fetching external metrics:', error);
        showMessage(`Error loading metrics: ${error.message}`, 'error');
      }
    }
    
    // ===== FILE HANDLING FUNCTIONS =====
    // ... (keep all your existing file handling functions EXACTLY as they are) ...
    // Handle file selection
    function handleFileSelect(e) {
      const file = e.target.files[0];
      handleFile(file);
    }
    
    function handleFile(file) {
      if (!file) return;
      
      // Check if it's a CSV file
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showMessage('Please select a CSV file', 'error');
        return;
      }
      
      selectedFile = file;
      
      // Update UI
      document.getElementById('fileName').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      document.getElementById('fileUploadArea').classList.add('has-file');
      
      // Read and preview CSV
      readCSVFile(file);
    }
    
    // Read CSV file
    function readCSVFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const csvText = e.target.result;
        parseCSV(csvText);
      };
      
      reader.onerror = function() {
        showMessage('Error reading file', 'error');
      };
      
      reader.readAsText(file);
    }
    
    // ULTRA ROBUST CSV PARSER - specifically for your Excel-style CSV
    function parseCSV(csvText) {
      try {
        // Log raw input for debugging
        console.log('Raw CSV text first 500 chars:', csvText.substring(0, 500));
        
        // Handle BOM and different line endings
        let text = csvText;
        
        // Remove BOM if present
        if (text.charCodeAt(0) === 0xFEFF || text.charCodeAt(0) === 0xFFFE) {
          text = text.substring(1);
        }
        
        // Replace different line endings with \n
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        const lines = text.split('\n');
        console.log('Total lines found:', lines.length);
        
        if (lines.length === 0) {
          showMessage('CSV file is empty', 'error');
          return;
        }
        
        // Find first non-empty line for headers
        let headerLineIndex = 0;
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].trim().length > 0) {
            headerLineIndex = i;
            break;
          }
        }
        
        // Get the header line
        const headerLine = lines[headerLineIndex];
        console.log('Header line raw:', headerLine);
        
        // SPECIAL FIX: For Excel CSVs that might have the entire line in quotes or other issues
        // Let's split by comma but be smart about it
        let headers = [];
        
        // Try multiple parsing strategies
        if (headerLine.includes('"')) {
          // Handle quoted headers
          headers = headerLine.match(/(?:[^,"]+|"[^"]*")+/g) || [];
          headers = headers.map(h => h.replace(/^"|"$/g, '').trim());
        } else {
          // Simple split for unquoted headers
          headers = headerLine.split(',').map(h => h.trim());
        }
        
        // Clean up headers - remove any empty ones
        headers = headers.filter(h => h.length > 0);
        
        console.log('Headers found:', headers);
        console.log('Number of headers:', headers.length);
        
        // Parse data rows
        csvData = [];
        
        for (let i = headerLineIndex + 1; i < lines.length; i++) {
          const line = lines[i].trim();
          
          // Skip empty lines
          if (!line || line === '' || line.replace(/,/g, '').trim().length === 0) {
            continue;
          }
          
          console.log(`Processing line ${i}:`, line);
          
          let values = [];
          
          // Try different parsing strategies for data rows too
          if (line.includes('"')) {
            // Handle quoted values
            values = line.match(/(?:[^,"]+|"[^"]*")+/g) || [];
            values = values.map(v => v.replace(/^"|"$/g, '').trim());
          } else {
            // Simple split for unquoted values
            values = line.split(',').map(v => v.trim());
          }
          
          // Ensure we have enough values for all headers
          while (values.length < headers.length) {
            values.push('');
          }
          
          // Create row object
          const row = {};
          let hasData = false;
          
          for (let j = 0; j < headers.length; j++) {
            const header = headers[j];
            const value = values[j] || '';
            row[header] = value;
            
            if (value && value.trim().length > 0) {
              hasData = true;
            }
          }
          
          // Log the parsed row for debugging
          console.log(`Row ${csvData.length + 1}:`, row);
          
          if (hasData) {
            csvData.push(row);
          }
        }
        
        if (csvData.length === 0) {
          showMessage('No valid data found in CSV file. Please ensure your CSV has data rows.', 'error');
          return;
        }
        
        console.log(`Successfully parsed ${csvData.length} valid rows from CSV`);
        console.log('First row data:', csvData[0]);
        
        // Show preview
        showCSVPreview(headers, csvData);
        
      } catch (error) {
        console.error('Error parsing CSV:', error);
        showMessage(`Error parsing CSV: ${error.message}. Please ensure your CSV is properly formatted.`, 'error');
      }
    }
    
    // Show CSV preview
    function showCSVPreview(headers, data) {
      const previewDiv = document.getElementById('csvPreview');
      previewDiv.innerHTML = '';
      
      if (data.length === 0) {
        previewDiv.innerHTML = '<div class="muted">No data found in CSV file</div>';
        return;
      }
      
      // Create table
      const table = document.createElement('table');
      
      // Create header row
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create body with first 10 rows
      const tbody = document.createElement('tbody');
      const displayRows = Math.min(data.length, 10);
      for (let i = 0; i < displayRows; i++) {
        const row = document.createElement('tr');
        headers.forEach(header => {
          const td = document.createElement('td');
          const value = data[i][header] || '';
          td.textContent = value.length > 50 ? value.substring(0, 50) + '...' : value;
          td.title = value;
          row.appendChild(td);
        });
        tbody.appendChild(row);
      }
      table.appendChild(tbody);
      
      previewDiv.appendChild(table);
      
      // Show total count
      const countDiv = document.createElement('div');
      countDiv.className = 'muted';
      countDiv.style.marginTop = '12px';
      countDiv.textContent = `Showing ${displayRows} of ${data.length} rows`;
      previewDiv.appendChild(countDiv);
      
      // Show CSV preview card
      document.getElementById('csvPreviewCard').style.display = 'block';
    }
    
    // Convert CSV data to JSON - UPDATED TO HANDLE MISSPELLED "DateOccured"
    function convertToJson() {
      const metricSelect = document.getElementById('metric-select');
      if (!metricSelect.value) {
        showMessage('Please select a metric first', 'error');
        return;
      }
      
      try {
        // Transform CSV data to the required JSON schema
        const items = [];
        let validationErrors = [];
        
        console.log('Converting CSV to JSON. CSV data:', csvData);
        
        csvData.forEach((row, index) => {
          try {
            // Log the row being processed
            console.log(`Processing row ${index}:`, row);
            
            // Normalize column names (case-insensitive)
            const normalizedRow = {};
            Object.keys(row).forEach(key => {
              normalizedRow[key.toLowerCase()] = row[key];
            });
            
            console.log(`Normalized row ${index}:`, normalizedRow);
            
            // Get values with fallbacks for different column names
            const userId = normalizedRow.userid || normalizedRow.user_id || '';
            const userEmail = normalizedRow.useremail || normalizedRow.user_email || normalizedRow.email || '';
            
            // FIX: Handle both "dateoccurred" (correct) and "dateoccured" (misspelled)
            const dateOccurredRaw = normalizedRow.dateoccurred || normalizedRow.dateoccured || normalizedRow.date_occurred || normalizedRow.date || '';
            
            const value = normalizedRow.value || '0';
            const type = normalizedRow.type || '';
            
            console.log(`Row ${index} values:`, { userId, userEmail, dateOccurredRaw, value, type });
            
            // Validate required fields
            if (!userId && !userEmail) {
              throw new Error(`Row ${index + 2}: Either UserID or UserEmail is required`);
            }
            
            if (!dateOccurredRaw) {
              throw new Error(`Row ${index + 2}: DateOccurred is required. Found columns: ${Object.keys(normalizedRow).join(', ')}`);
            }
            
            // Convert date format from UK (DD/MM/YYYY) to ISO (YYYY-MM-DD)
            const dateOccurredISO = convertToISODate(dateOccurredRaw);
            console.log(`Row ${index} date conversion: "${dateOccurredRaw}" -> "${dateOccurredISO}"`);
            
            if (!validateISODate(dateOccurredISO)) {
              throw new Error(`Row ${index + 2}: Invalid date format. Use DD/MM/YYYY or YYYY-MM-DD. Got: "${dateOccurredRaw}"`);
            }
            
            // Validate type field
            const normalizedType = type.toLowerCase().trim();
            if (!normalizedType) {
              throw new Error(`Row ${index + 2}: Type is required and must be "Total" or "Cumulative"`);
            }
            
            if (normalizedType !== 'total' && normalizedType !== 'cumulative') {
              throw new Error(`Row ${index + 2}: Type must be "Total" or "Cumulative" (got: "${type}")`);
            }
            
            // Parse numeric value
            const parsedValue = parseFloat(value);
            if (isNaN(parsedValue)) {
              throw new Error(`Row ${index + 2}: Value must be a number (got: "${value}")`);
            }
            
            // Create item according to the correct JSON structure
            const item = {
              metricId: metricSelect.value,
              type: type.charAt(0).toUpperCase() + type.slice(1).toLowerCase(), // Capitalize first letter
              dateOccurred: dateOccurredISO,
              value: parsedValue
            };
            
            // Add userId OR userEmail (not both required in your example)
            if (userId) {
              item.userId = userId;
            } else if (userEmail) {
              item.userEmail = userEmail;
            }
            
            console.log(`Created item for row ${index}:`, item);
            items.push(item);
            
          } catch (rowError) {
            console.error(`Error in row ${index}:`, rowError.message);
            validationErrors.push(rowError.message);
          }
        });
        
        if (validationErrors.length > 0) {
          throw new Error(`Validation errors:\n${validationErrors.join('\n')}`);
        }
        
        if (items.length === 0) {
          throw new Error('No valid data to convert');
        }
        
        jsonData = {
          items: items
        };
        
        console.log(`Converted ${items.length} rows to JSON`);
        console.log('Sample JSON item:', items[0]);
        
        // Update JSON preview
        updateJsonPreview();
        
        // Show JSON preview card
        document.getElementById('jsonPreviewCard').style.display = 'block';
        
        showMessage(`Successfully converted ${items.length} rows to JSON format`, 'success');
        
      } catch (error) {
        console.error('Error converting to JSON:', error);
        showMessage(`Error converting data: ${error.message}`, 'error');
      }
    }
    
    // Update JSON preview
    function updateJsonPreview() {
      if (!jsonData) return;
      
      // Create a copy to preview (limit to 5 items for preview)
      const previewData = {
        items: jsonData.items.slice(0, 5)
      };
      
      // Update metricId in preview if changed
      if (selectedMetricId) {
        previewData.items.forEach(item => {
          item.metricId = selectedMetricId;
        });
      }
      
      const jsonPreview = document.getElementById('jsonPreview');
      jsonPreview.textContent = JSON.stringify(previewData, null, 2);
      
      // Show total count
      const countInfo = document.createElement('div');
      countInfo.className = 'muted';
      countInfo.style.marginTop = '12px';
      countInfo.textContent = `Total items to upload: ${jsonData.items.length}`;
      
      // Remove existing count info if present
      const existingCount = jsonPreview.parentNode.querySelector('.muted');
      if (existingCount) {
        existingCount.remove();
      }
      
      jsonPreview.parentNode.appendChild(countInfo);
    }
    
    // Upload data to PureCloud - FIXED with better token validation
    async function uploadDataToPureCloud() {
      if (!jsonData || !selectedMetricId) {
        showMessage('No data to upload', 'error');
        return;
      }
      
      if (!accessToken) {
        showMessage('Authentication required. Please refresh the page to re-authenticate.', 'error');
        return;
      }
      
      const button = document.getElementById('uploadDataBtn');
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = 'Uploading...';
      
      const resultsDiv = document.getElementById('results');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div class="info-message"><span class="loading"><span class="spinner"></span> Uploading data...</span></div>';
      
      try {
        // Update all items with the selected metric ID
        jsonData.items.forEach(item => {
          item.metricId = selectedMetricId;
        });
        
        console.log(`Uploading ${jsonData.items.length} items to PureCloud...`);
        console.log('Sample data being sent:', jsonData.items[0]);
        console.log('Using access token (first 20 chars):', accessToken.substring(0, 20) + '...');
        
        // Make API call
        const response = await fetch('https://api.mypurecloud.ie/api/v2/employeeperformance/externalmetrics/data', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(jsonData)
        });
        
        console.log('Upload response status:', response.status);
        
        const responseText = await response.text();
        console.log('Upload response text:', responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          data = { message: responseText };
        }
        
        if (!response.ok) {
          console.error('Upload failed with data:', data);
          throw new Error(data.message || `HTTP ${response.status}: ${JSON.stringify(data)}`);
        }
        
        // Success
        resultsDiv.innerHTML = `
          <div class="success-message">
            ✅ Successfully uploaded ${jsonData.items.length} metric data points!
          </div>
          <div class="warning-note" style="margin-top: 12px;">
            <strong>⚠️ Important:</strong> Data has been submitted to Genesys and cannot be reverted.
          </div>
        `;
        
        // Reset form
        resetForm();
        
      } catch (error) {
        console.error('Error uploading data:', error);
        resultsDiv.innerHTML = `
          <div class="error-message">
            ❌ Error uploading data: ${error.message}
          </div>
          <div class="muted" style="margin-top: 8px;">
            Please check your data and try again.
          </div>
        `;
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }
    
    // Reset form
    function resetForm() {
      selectedFile = null;
      csvData = [];
      jsonData = null;
      
      // Reset UI
      document.getElementById('fileName').textContent = '';
      document.getElementById('fileUploadArea').classList.remove('has-file');
      document.getElementById('fileInput').value = '';
      document.getElementById('csvPreviewCard').style.display = 'none';
      document.getElementById('jsonPreviewCard').style.display = 'none';
    }
  </script>
</body>
</html>
